{# ===== SUKOON PRODUCT CARD ===== #}
{# Usage: {% ui "product-card.njk", product=productObj %} #}

{% set product = data.product %}
{% set pricing = product.pricing %}
{% set hasDiscount = pricing and pricing.compareAtPrice and pricing.compareAtPrice > pricing.price %}
{% set discount = ((pricing.compareAtPrice - pricing.price) / pricing.compareAtPrice * 100) | round if hasDiscount else 0 %}
{% set imageUrl = product.images[0].fileUrl if product.images and product.images | length > 0 else '' %}
{% set canPurchase = product.allowBackorder or (not product.trackQuantity) or product.quantity > 0 %}


<div class="group flex flex-col h-full" x-data="productCard('{{ product._id }}')">

  {# ——— Image ——— #}
  <div class="relative mb-3">
    <a href="/product/{{ product.slug }}" class="block overflow-hidden rounded-2xl">
      <div class="aspect-[3/4] bg-secondary">
        {% if imageUrl %}
          <img
            src="{{ imageUrl }}"
            alt="{{ product.title }}"
            class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-105 img-fade"
            loading="lazy"
            onload="this.classList.add('is-loaded')"
          />
        {% else %}
          <div class="w-full h-full flex items-center justify-center">
            <svg class="w-12 h-12 text-tertiary" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24">
              <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        {% endif %}
      </div>
    </a>

    {# Discount Badge #}
    {% if hasDiscount %}
      <span class="absolute top-2.5 start-2.5 px-2 py-1 rounded-lg text-[11px] font-semibold bg-red-500 text-white">
        -{{ discount }}%
      </span>
    {% endif %}

    {# Wishlist Button #}
    <button @click.prevent="toggleWishlist()"
            :disabled="wishlistLoading"
            class="absolute top-2.5 end-2.5 w-8 h-8 rounded-full bg-white/90 dark:bg-black/50 backdrop-blur-sm flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-all duration-300 hover:scale-110"
            :class="inWishlist ? 'text-red-500 !opacity-100' : 'text-secondary hover:text-red-400'">
      <svg class="w-4 h-4" :fill="inWishlist ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
      </svg>
    </button>
  </div>

  {# ——— Content ——— #}
  <div class="flex flex-col flex-1 gap-1.5 px-0.5">

    {# Title #}
    <a href="/product/{{ product.slug }}" class="text-[14px] font-medium leading-snug line-clamp-2 text-primary hover:text-accent transition-colors duration-200">
      {{ product.title }}
    </a>

    {# Rating #}
    {% if product.averageRating and product.averageRating > 0 %}
      <div class="flex items-center gap-1">
        <div class="flex items-center gap-0.5">
          {% for i in range(5) %}
            <svg class="w-3 h-3 {% if i < product.averageRating %}text-amber-400{% else %}text-tertiary opacity-40{% endif %}" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
          {% endfor %}
        </div>
        {% if product.totalReviews %}
          <span class="text-[11px] text-tertiary">({{ product.totalReviews }})</span>
        {% endif %}
      </div>
    {% endif %}

    {# Option Swatches (color circles or text tags) #}
    {% if product.options and product.options | length > 0 %}
      {% for option in product.options %}
        {% if option.values and option.values | length > 0 %}
          <div class="flex items-center gap-1.5 flex-wrap mt-0.5">
            {% if option.type == 'color' %}
              {# Color swatches #}
              {% for value in option.values %}
                {% if loop.index0 < 5 %}
                  <span class="w-3.5 h-3.5 rounded-full border shrink-0" style="background-color: {{ value.value | default('#ccc') }};" title="{{ value.label }}"></span>
                {% endif %}
              {% endfor %}
              {% if option.values | length > 5 %}
                <span class="text-[10px] text-tertiary">+{{ option.values | length - 5 }}</span>
              {% endif %}
            {% else %}
              {# Text option tags #}
              {% for value in option.values %}
                {% if loop.index0 < 4 %}
                  <span class="px-2 py-0.5 rounded-md bg-tertiary text-[10px] text-secondary leading-tight">{{ value.label }}</span>
                {% endif %}
              {% endfor %}
              {% if option.values | length > 4 %}
                <span class="text-[10px] text-tertiary">+{{ option.values | length - 4 }}</span>
              {% endif %}
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    {# Price #}
    <div class="flex items-baseline gap-2 mt-auto pt-1">
      {% if pricing and pricing.price > 0 %}
        <span class="text-[15px] font-bold text-primary">
          {{ pricing.price | money }}
        </span>
      {% endif %}
      {% if hasDiscount %}
        <span class="text-[12px] line-through text-tertiary">
          {{ pricing.compareAtPrice | money }}
        </span>
      {% endif %}
    </div>

    {# Add to Cart Button #}
    {% if canPurchase %}
      {% if product.variantsCount and product.variantsCount > 0 %}
        {# Has variants — link to product page #}
        <a href="/product/{{ product.slug }}"
           class="flex items-center justify-center gap-2 w-full py-3 mt-2 rounded-2xl text-sm font-semibold border text-secondary hover:border-accent hover:bg-accent hover:text-white transition-all duration-200">
          {{t('pages.product.choose_options') | default('Choose options')}}
          <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
          </svg>
        </a>
      {% else %}
        {# Simple product — add to cart directly #}
        <button @click="addToCart()"
                :disabled="cartLoading || cartSuccess"
                class="flex items-center justify-center gap-2 w-full py-3 mt-2 rounded-2xl text-sm font-semibold transition-all duration-300"
                :class="cartSuccess ? 'bg-green-500 text-white' : 'bg-accent text-white hover:bg-accent-hover'">
          {# Loading #}
          <span x-show="cartLoading" class="flex items-center justify-center gap-2">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
          </span>
          {# Success #}
          <span x-show="cartSuccess && !cartLoading" x-cloak class="flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            {{t('pages.product.added') | default('Added')}}
          </span>
          {# Default #}
          <span x-show="!cartLoading && !cartSuccess" class="flex items-center justify-center gap-2">
            {{t('pages.product.add_to_cart') | default('Add to cart')}}
            <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </span>
        </button>
      {% endif %}
    {% else %}
      {# Out of stock #}
      <div class="flex items-center justify-center w-full py-3 mt-2 rounded-2xl text-xs font-medium text-tertiary bg-tertiary">
        {{t('pages.product.out_of_stock') | default('Out of stock')}}
      </div>
    {% endif %}
  </div>
</div>
