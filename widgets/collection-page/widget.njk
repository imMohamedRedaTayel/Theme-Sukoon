{# Single Collection Page Widget - Qamar Theme #}
{% set products = context.products | default([]) %}
{% set pagination = context.pagination %}
{% set columns_desktop = widget.data.columns_desktop | default('3') %}
{% set show_description = widget.data.show_description | default(true) %}
{% set show_sort = widget.data.show_sort | default(true) %}
{% set show_filters = widget.data.show_filters if widget.data.show_filters is defined else true %}
{% set filters = context.filters | default([]) %}
{% set hasFilters = show_filters and filters | length > 0 %}
{% set hasSidebar = show_sort or hasFilters %}

{# Card display settings #}
{% set _cs_rating = widget.data.card_show_rating if widget.data.card_show_rating is defined else true %}
{% set _cs_options = widget.data.card_show_options if widget.data.card_show_options is defined else true %}
{% set _cs_badge = widget.data.card_show_badge if widget.data.card_show_badge is defined else true %}
{% set _cs_button = widget.data.card_show_button if widget.data.card_show_button is defined else true %}
{% set _cs_compare = widget.data.card_show_compare_price if widget.data.card_show_compare_price is defined else true %}
{% set _cs_wishlist = widget.data.card_show_wishlist | default(false) %}
{% set _cs_ratio = widget.data.card_image_ratio | default('square') %}
{% set _cs_lines = widget.data.card_title_lines | default('2') %}
{% set _cs_fit = widget.data.card_image_fit | default('contain') %}
{% set _cs_hover = widget.data.card_hover_effect | default('zoom') %}
{% set _cs_radius = widget.data.card_border_radius | default('lg') %}

{# Discover range filter handle dynamically #}
{% set _rangeHandle = 'price' %}
{% for filter in filters %}
  {% if filter.inputType == 'range' %}
    {% set _rangeHandle = filter.handle %}
  {% endif %}
{% endfor %}

{{ context | json }}

<section class="py-6 md:py-10" x-data="collectionFilter({
  collectionId: '{{ collection._id }}',
  rangeHandle: '{{ _rangeHandle }}',
  cardSettings: {
    showRating: {{ _cs_rating }},
    showOptions: {{ _cs_options }},
    showBadge: {{ _cs_badge }},
    imageRatio: '{{ _cs_ratio }}',
    showButton: {{ _cs_button }},
    showComparePrice: {{ _cs_compare }},
    titleLines: '{{ _cs_lines }}',
    imageFit: '{{ _cs_fit }}',
    hoverEffect: '{{ _cs_hover }}',
    showWishlist: {{ _cs_wishlist }},
    borderRadius: '{{ _cs_radius }}',
    gridClass: '{% if hasSidebar %}md:grid-cols-2 lg:grid-cols-3{% elif columns_desktop == "3" %}md:grid-cols-3{% else %}md:grid-cols-4{% endif %}'
  },
  translations: {
    addToCart: '{{t("product.add_to_cart")}}',
    chooseOptions: '{{t("product.choose_options")}}',
    outOfStock: '{{t("product.out_of_stock")}}',
    added: '{{t("product.added")}}',
    noProducts: '{{t("collection.no_products")}}',
    noResults: '{{t("common.no_results")}}',
    home: '{{t("common.home")}}',
    products: '{{t("common.products")}}'
  }
})">
  <div class="container mx-auto px-4">

    {# ===== Breadcrumb ===== #}
    <nav class="mb-5 md:mb-6" aria-label="breadcrumb">
      <ol class="flex items-center gap-1.5 text-xs md:text-sm text-gray-400">
        <li><a href="/" class="hover:text-primary transition-colors">{{t('common.home')}}</a></li>
        <li>
          <svg class="w-3 h-3 rtl:rotate-180 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </li>
        <li><a href="/collections" class="hover:text-primary transition-colors">{{t('common.categories')}}</a></li>
        <li>
          <svg class="w-3 h-3 rtl:rotate-180 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </li>
        <li class="text-gray-600 font-medium">{{ collection.title }}</li>
      </ol>
    </nav>

    {# ===== Collection Header ===== #}
    <div class="mb-6 md:mb-8">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">{{ collection.title }}</h1>
      {% if show_description and collection.description %}
        <p class="text-gray-500 text-sm md:text-base mt-2 max-w-2xl">{{ collection.description }}</p>
      {% endif %}
    </div>

    {# ===== Main Layout: Sidebar + Grid ===== #}
    <div class="{% if hasSidebar %}flex gap-8{% endif %}">

      {# ===== Desktop Sidebar ===== #}
      {% if hasSidebar %}
        <aside class="hidden md:block w-64 flex-shrink-0">
          <div class="sticky bottom-6 space-y-5">
            {# Products Count #}
            <div id="products-count" class="bg-white rounded-2xl border border-gray-100 p-5">
              <p class="text-sm text-gray-600">
                <span class="font-bold text-gray-800">{% if pagination %}{{ pagination.totalItems }}{% else %}{{ products | length }}{% endif %}</span>
                {{t('common.products')}}
              </p>
              <template x-if="activeCount > 0">
                <button @click="clearFilters()"
                        class="mt-2 text-xs text-red-500 hover:text-red-600 font-medium transition-colors">
                  {{t('collection.clear_filters')}}
                </button>
              </template>
            </div>

            {% ui "filter-sidebar.njk", show_sort=show_sort, filters=filters, hasFilters=hasFilters %}

            {# Collection Image #}
            {% if collection.image %}
              <div class="rounded-2xl overflow-hidden">
                <img src="{{ collection.image.fileUrl }}"
                     alt="{{ collection.title }}"
                     class="w-full h-auto object-cover"
                     loading="lazy">
              </div>
            {% endif %}
          </div>
        </aside>
      {% endif %}

      {# ===== Products Area ===== #}
      <div class="flex-1 min-w-0">

        {# Mobile Toolbar + Bottom Sheets #}
        {% ui "filter-mobile.njk", show_sort=show_sort, filters=filters, hasFilters=hasFilters, hasSidebar=hasSidebar %}

        {# Products Grid Wrapper (swapped via AJAX) #}
        <div id="products-grid-wrapper" class="relative min-h-[200px]">

          {# Loading Overlay #}
          <div x-show="loading" x-cloak
               class="absolute inset-0 bg-white/70 z-10 flex items-center justify-center rounded-2xl"
               style="backdrop-filter: blur(2px);"
               x-transition:enter="transition ease-out duration-200"
               x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
               x-transition:leave="transition ease-in duration-150"
               x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
            <svg class="w-8 h-8 animate-spin text-primary" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>

          {% if products | length > 0 %}
            <div class="grid grid-cols-2 gap-3 md:gap-5
              {% if hasSidebar %}
                md:grid-cols-2 lg:grid-cols-3
              {% else %}
                {% if columns_desktop == '3' %} md:grid-cols-3
                {% else %} md:grid-cols-4
                {% endif %}
              {% endif %}">
              {% for product in products %}
                {% ui "product-card.njk", product=product, show_rating=_cs_rating, show_options=_cs_options, show_badge=_cs_badge, image_ratio=_cs_ratio, show_button=_cs_button, show_compare_price=_cs_compare, title_lines=_cs_lines, image_fit=_cs_fit, hover_effect=_cs_hover, show_wishlist=_cs_wishlist, border_radius=_cs_radius %}
              {% endfor %}
            </div>

            {# Pagination (AJAX) #}
            {% if pagination and pagination.totalPages > 1 %}
              <nav class="flex items-center justify-center gap-1.5 mt-10" aria-label="pagination">
                {% if pagination.currentPage > 1 %}
                  <button @click.prevent="goToPage({{ pagination.currentPage - 1 }})"
                     class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-primary transition-colors">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                  </button>
                {% else %}
                  <span class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-200">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                  </span>
                {% endif %}

                {% for i in range(1, pagination.totalPages + 1) %}
                  {% if i == pagination.currentPage %}
                    <span class="w-10 h-10 rounded-xl flex items-center justify-center bg-primary text-white font-semibold text-sm">{{ i }}</span>
                  {% elif i == 1 or i == pagination.totalPages or (i >= pagination.currentPage - 1 and i <= pagination.currentPage + 1) %}
                    <button @click.prevent="goToPage({{ i }})"
                       class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-600 hover:bg-gray-100 hover:text-primary transition-colors text-sm font-medium">{{ i }}</button>
                  {% elif i == pagination.currentPage - 2 or i == pagination.currentPage + 2 %}
                    <span class="w-6 flex items-center justify-center text-gray-300 text-sm">...</span>
                  {% endif %}
                {% endfor %}

                {% if pagination.hasNextPage %}
                  <button @click.prevent="goToPage({{ pagination.currentPage + 1 }})"
                     class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-primary transition-colors">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </button>
                {% else %}
                  <span class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-200">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </span>
                {% endif %}
              </nav>
            {% endif %}

          {% else %}
            <div class="flex flex-col items-center justify-center py-20 text-center">
              <div class="w-24 h-24 rounded-full bg-gray-50 flex items-center justify-center mb-5">
                <svg class="w-12 h-12 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
              </div>
              <h3 class="text-lg font-bold text-gray-800 mb-2">{{t('collection.no_products')}}</h3>
              <p class="text-gray-500 text-sm mb-6">{{t('common.no_results')}}</p>
              <a href="/" class="inline-flex items-center gap-2 text-sm font-semibold text-primary hover:opacity-80 transition-colors">
                {{t('common.home')}}
                <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </a>
            </div>
          {% endif %}

        </div>
      </div>
    </div>

  </div>
</section>
