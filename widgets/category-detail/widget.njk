{# ===== SUKOON COLLECTION PAGE ===== #}

{% set products = context.products | default([]) %}
{% set pagination = context.pagination %}
{% set columns_desktop = widget.data.columns_desktop | default('3') %}
{% set show_description = widget.data.show_description | default(true) %}
{% set show_sort = widget.data.show_sort | default(true) %}
{% set show_filters = widget.data.show_filters if widget.data.show_filters is defined else true %}
{% set filters = context.filters | default([]) %}
{% set hasFilters = show_filters and filters | length > 0 %}
{% set hasSidebar = show_sort or hasFilters %}

{# Card display settings #}
{% set _cs_rating = widget.data.card_show_rating if widget.data.card_show_rating is defined else true %}
{% set _cs_options = widget.data.card_show_options if widget.data.card_show_options is defined else true %}
{% set _cs_badge = widget.data.card_show_badge if widget.data.card_show_badge is defined else true %}
{% set _cs_button = widget.data.card_show_button if widget.data.card_show_button is defined else true %}
{% set _cs_compare = widget.data.card_show_compare_price if widget.data.card_show_compare_price is defined else true %}
{% set _cs_wishlist = widget.data.card_show_wishlist | default(false) %}
{% set _cs_ratio = widget.data.card_image_ratio | default('square') %}
{% set _cs_lines = widget.data.card_title_lines | default('2') %}
{% set _cs_fit = widget.data.card_image_fit | default('contain') %}
{% set _cs_hover = widget.data.card_hover_effect | default('zoom') %}
{% set _cs_radius = widget.data.card_border_radius | default('lg') %}

{# Discover range filter handle dynamically #}
{% set _rangeHandle = 'price' %}
{% for filter in filters %}
  {% if filter.inputType == 'range' %}
    {% set _rangeHandle = filter.handle %}
  {% endif %}
{% endfor %}


<section id="{{ widget.id }}" class="bg-section-a min-h-[70vh]" x-data="collectionFilter({
  collectionId: '{{ collection._id }}',
  rangeHandle: '{{ _rangeHandle }}',
  cardSettings: {
    showRating: {{ _cs_rating }},
    showOptions: {{ _cs_options }},
    showBadge: {{ _cs_badge }},
    imageRatio: '{{ _cs_ratio }}',
    showButton: {{ _cs_button }},
    showComparePrice: {{ _cs_compare }},
    titleLines: '{{ _cs_lines }}',
    imageFit: '{{ _cs_fit }}',
    hoverEffect: '{{ _cs_hover }}',
    showWishlist: {{ _cs_wishlist }},
    borderRadius: '{{ _cs_radius }}',
    gridClass: '{% if hasSidebar %}md:grid-cols-2 lg:grid-cols-3{% elif columns_desktop == "3" %}md:grid-cols-3{% else %}md:grid-cols-4{% endif %}'
  },
  translations: {
    addToCart: '{{ t("product.add_to_cart") | default("Add to cart") }}',
    chooseOptions: '{{ t("product.choose_options") | default("Choose options") }}',
    outOfStock: '{{ t("product.out_of_stock") | default("Out of stock") }}',
    added: '{{ t("product.added") | default("Added") }}',
    noProducts: '{{ t("collection.no_products") | default("No products") }}',
    noResults: '{{ t("common.no_results") | default("No results found") }}',
    home: '{{ t("common.home") | default("Home") }}',
    products: '{{ t("common.products") | default("Products") }}'
  }
})">

  {# ===== Collection Banner ===== #}
  {% if collection.image and collection.image.fileUrl %}
    <div class="relative overflow-hidden aspect-[4/1] max-lg:aspect-[3/1] max-sm:aspect-[2/1]">
      <img src="{{ collection.image.fileUrl }}" alt="{{ collection.title }}"
           class="w-full h-full object-cover img-fade" onload="this.classList.add('is-loaded')"/>
      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-black/5"></div>
      <div class="absolute inset-0 flex items-end">
        <div class="container mx-auto px-6 lg:px-12 max-sm:px-4 pb-8 max-sm:pb-5">
          {# Breadcrumb #}
          <nav class="mb-3" aria-label="breadcrumb">
            <ol class="flex items-center gap-1.5 text-[11px] text-white/60">
              <li><a href="/" class="hover:text-white transition-colors">{{ t('common.home') | default('Home') }}</a></li>
              <li><svg class="w-2.5 h-2.5 rtl:rotate-180 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg></li>
              <li><a href="/collections" class="hover:text-white transition-colors">{{ t('common.categories') | default('Categories') }}</a></li>
              <li><svg class="w-2.5 h-2.5 rtl:rotate-180 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg></li>
              <li class="text-white/90 font-medium">{{ collection.title }}</li>
            </ol>
          </nav>
          <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white" style="text-shadow: 0 2px 20px rgba(0,0,0,0.2);">
            {{ collection.title }}
          </h1>
          {% if show_description and collection.description %}
            <p class="text-white/70 text-sm mt-2 max-w-xl line-clamp-2 max-sm:hidden">{{ collection.description | safe }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% else %}
    {# Text-only header #}
    <div class="container mx-auto px-6 lg:px-12 max-sm:px-4 pt-8 md:pt-10">
      <nav class="mb-4" aria-label="breadcrumb">
        <ol class="flex items-center gap-1.5 text-xs text-gray-400">
          <li><a href="/" class="hover:text-gray-600 transition-colors">{{ t('common.home') | default('Home') }}</a></li>
          <li><svg class="w-3 h-3 rtl:rotate-180 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></li>
          <li><a href="/collections" class="hover:text-gray-600 transition-colors">{{ t('common.categories') | default('Categories') }}</a></li>
          <li><svg class="w-3 h-3 rtl:rotate-180 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></li>
          <li class="text-gray-600 font-medium">{{ collection.title }}</li>
        </ol>
      </nav>
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">{{ collection.title }}</h1>
      {% if show_description and collection.description %}
        <p class="text-gray-500 text-sm mt-2 max-w-2xl">{{ collection.description | safe }}</p>
      {% endif %}
    </div>
  {% endif %}

  {# ===== Main Content ===== #}
  <div class="container mx-auto px-6 lg:px-12 max-sm:px-4 py-8 md:py-10">

    {# Toolbar bar â€” product count + active filters #}
    <div class="flex items-center justify-between mb-6 pb-5 border-b border-gray-100">
      <div id="products-count">
        <p class="text-sm text-gray-500">
          <span class="font-bold text-gray-900">{% if pagination %}{{ pagination.totalItems }}{% else %}{{ products | length }}{% endif %}</span>
          {{ t('common.products') | default('Products') }}
        </p>
      </div>
      <div class="flex items-center gap-2">
        <button x-show="activeCount > 0" x-cloak @click="clearFilters()"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[11px] font-semibold text-red-500 bg-red-50 hover:bg-red-100 transition-colors">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          {{ t('collection.clear_filters') | default('Clear all') }}
        </button>
      </div>
    </div>

    {# Layout: Sidebar + Grid #}
    <div class="{% if hasSidebar %}flex gap-8 lg:gap-10{% endif %}">

      {# ===== Desktop Sidebar ===== #}
      {% if hasSidebar %}
        <aside class="hidden md:block w-[240px] shrink-0">
          <div class="sticky top-24 space-y-3">
            {% ui "filter-sidebar.njk", show_sort=show_sort, filters=filters, hasFilters=hasFilters %}
          </div>
        </aside>
      {% endif %}

      {# ===== Products Area ===== #}
      <div class="flex-1 min-w-0">

        {# Mobile Filter/Sort #}
        {% ui "filter-mobile.njk", show_sort=show_sort, filters=filters, hasFilters=hasFilters, hasSidebar=hasSidebar %}

        {# Products Grid (swapped via AJAX) #}
        <div id="products-grid-wrapper" class="relative min-h-[200px]">

          {# Loading Overlay #}
          <div x-show="loading" x-cloak
               class="absolute inset-0 bg-white/60 z-10 flex items-center justify-center"
               style="backdrop-filter: blur(3px);"
               x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
               x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
            <div class="flex flex-col items-center gap-3">
              <svg class="w-7 h-7 animate-spin text-gray-400" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </div>

          {% if products | length > 0 %}
            <div class="grid grid-cols-2 gap-3 md:gap-5
              {% if hasSidebar %}
                md:grid-cols-2 lg:grid-cols-3
              {% else %}
                {% if columns_desktop == '3' %} md:grid-cols-3
                {% else %} md:grid-cols-4
                {% endif %}
              {% endif %}">
              {% for product in products %}
                {% ui "product-card.njk", product=product, show_rating=_cs_rating, show_options=_cs_options, show_badge=_cs_badge, image_ratio=_cs_ratio, show_button=_cs_button, show_compare_price=_cs_compare, title_lines=_cs_lines, image_fit=_cs_fit, hover_effect=_cs_hover, show_wishlist=_cs_wishlist, border_radius=_cs_radius %}
              {% endfor %}
            </div>

            {# Pagination #}
            {% if pagination and pagination.totalPages > 1 %}
              <nav class="flex items-center justify-center gap-1 mt-12" aria-label="pagination">
                {# Prev #}
                {% if pagination.currentPage > 1 %}
                  <button @click.prevent="goToPage({{ pagination.currentPage - 1 }})"
                          class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:bg-gray-100 hover:text-gray-700 transition-all">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                  </button>
                {% else %}
                  <span class="w-10 h-10 rounded-full flex items-center justify-center text-gray-200">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                  </span>
                {% endif %}

                {# Pages #}
                {% for i in range(1, pagination.totalPages + 1) %}
                  {% if i == pagination.currentPage %}
                    <span class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-900 text-white font-semibold text-sm shadow-sm">{{ i }}</span>
                  {% elif i == 1 or i == pagination.totalPages or (i >= pagination.currentPage - 1 and i <= pagination.currentPage + 1) %}
                    <button @click.prevent="goToPage({{ i }})"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-900 transition-all text-sm font-medium">{{ i }}</button>
                  {% elif i == pagination.currentPage - 2 or i == pagination.currentPage + 2 %}
                    <span class="w-6 flex items-center justify-center text-gray-300 text-xs">...</span>
                  {% endif %}
                {% endfor %}

                {# Next #}
                {% if pagination.hasNextPage %}
                  <button @click.prevent="goToPage({{ pagination.currentPage + 1 }})"
                          class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:bg-gray-100 hover:text-gray-700 transition-all">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  </button>
                {% else %}
                  <span class="w-10 h-10 rounded-full flex items-center justify-center text-gray-200">
                    <svg class="w-4 h-4 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  </span>
                {% endif %}
              </nav>
            {% endif %}

          {% else %}
            {# Empty State #}
            <div class="flex flex-col items-center justify-center py-24 text-center">
              <div class="w-20 h-20 rounded-full bg-gray-50 flex items-center justify-center mb-5">
                <svg class="w-9 h-9 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
              </div>
              <h3 class="text-base font-bold text-gray-800 mb-2">{{ t('collection.no_products') | default('No products in this collection') }}</h3>
              <p class="text-gray-400 text-sm mb-6 max-w-xs mx-auto">{{ t('common.no_results') | default('No results found') }}</p>
              <a href="/" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-semibold bg-gray-900 text-white hover:bg-gray-800 transition-colors">
                {{ t('common.continue_shopping') | default('Continue shopping') }}
                <svg class="w-3.5 h-3.5 rtl:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
              </a>
            </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</section>
