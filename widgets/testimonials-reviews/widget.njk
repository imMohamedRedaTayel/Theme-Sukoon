{# ===== SUKOON TESTIMONIALS & REVIEWS ===== #}

{% set title = widget.data.title | safe %}
{% set subtitle = widget.data.subtitle | safe %}
{% set reviews = widget.blocks %}
{% set id = widget.id %}

<section id="{{ id }}" class="bg-section-a py-20 max-lg:py-14 max-sm:py-10 relative overflow-hidden">

  {# Subtle Background Accents #}
  <div class="absolute -top-16 -end-16 w-[600px] h-[600px] rounded-full pointer-events-none"
       style="background: radial-gradient(circle, #DBBFC9 0%, transparent 60%); opacity: 0.6;"></div>
  <div class="absolute -bottom-24 -start-24 w-[550px] h-[550px] rounded-full pointer-events-none"
       style="background: radial-gradient(circle, #B8CCD9 0%, transparent 60%); opacity: 0.55;"></div>

  <div class="container mx-auto px-12 max-lg:px-6 max-sm:px-4 relative z-10">

    {# Section Header #}
    {% if title or subtitle %}
      <div class="text-center mb-14 max-sm:mb-10 reveal flex items-center justify-center flex-col ">
        {% if title %}
          <h2 class="mb-4">{{ title }}</h2>
        {% endif %}
        {% if subtitle %}
          <p class="text-body text-secondary" style="max-width: 50ch; margin-inline: auto;">
            {{ subtitle }}
          </p>
        {% endif %}
      </div>
    {% endif %}

    {# Reviews Swiper #}
    {% if reviews and reviews | length > 0 %}
      <div class="reveal">
        <div class="swiper" id="swiper-{{ id }}">
          <div class="swiper-wrapper" style="padding-bottom: 4px;">
            {% for block in reviews %}
              <div class="swiper-slide" style="height: auto;">
                <div class="flex flex-col gap-5 p-8 max-sm:p-6 rounded-xl h-full"
                     style="background: var(--color-surface); border: 1px solid var(--color-border);">

                  {# Stars #}
                  {% set rating = block.data.rating | default(5) %}
                  <div class="flex items-center gap-0.5">
                    {% for i in range(5) %}
                      <svg class="w-4 h-4 {% if i < rating %}text-warning{% else %}text-tertiary{% endif %}"
                           fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                    {% endfor %}
                  </div>

                  {# Review Text #}
                  {% if block.data.review_text %}
                    <p class="text-[15px] leading-relaxed text-secondary flex-1" style="max-width: none;">
                      {{ block.data.review_text | safe }}
                    </p>
                  {% endif %}

                  {# Reviewer Info #}
                  <div class="flex items-center gap-3 pt-4" style="border-top: 1px solid var(--color-border);">
                    {% if block.data.avatar and block.data.avatar.fileUrl %}
                      <img
                        src="{{ block.data.avatar.fileUrl }}"
                        alt="{{ block.data.reviewer_name }}"
                        class="w-10 h-10 rounded-full object-cover flex-shrink-0"
                        style="background: var(--color-bg-secondary);"
                        loading="lazy"
                      />
                    {% else %}
                      <div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center"
                           style="background: var(--color-accent-light); color: var(--color-accent);">
                        <span class="text-[14px] font-medium">
                          {{ block.data.reviewer_name | first | upper if block.data.reviewer_name else '?' }}
                        </span>
                      </div>
                    {% endif %}
                    <div class="flex flex-col">
                      {% if block.data.reviewer_name %}
                        <span class="text-[14px] font-medium text-primary">
                          {{ block.data.reviewer_name }}
                        </span>
                      {% endif %}
                      {% if block.data.reviewer_role %}
                        <span class="text-[12px] text-tertiary">
                          {{ block.data.reviewer_role }}
                        </span>
                      {% endif %}
                    </div>
                  </div>

                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        {# ——— Custom Navigation Bar ——— #}
        <div class="flex items-center justify-center gap-6 mt-10">
          {# Prev Arrow #}
          <button id="prev-{{ id }}" aria-label="Previous"
                  class="group w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300"
                  style="border: 1.5px solid var(--color-border); background: transparent;">
            <svg class="w-4 h-4 transition-transform duration-300 group-hover:-translate-x-0.5"
                 style="color: var(--color-text-secondary);"
                 fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          {# Pagination Dots #}
          <div id="dots-{{ id }}" class="flex items-center gap-2"></div>

          {# Next Arrow #}
          <button id="next-{{ id }}" aria-label="Next"
                  class="group w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300"
                  style="border: 1.5px solid var(--color-border); background: transparent;">
            <svg class="w-4 h-4 transition-transform duration-300 group-hover:translate-x-0.5"
                 style="color: var(--color-text-secondary);"
                 fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      {# Scoped Styles #}
      <style>
        #prev-{{ id }}:hover,
        #next-{{ id }}:hover {
          border-color: var(--color-accent);
          background: var(--color-accent);
        }
        #prev-{{ id }}:hover svg,
        #next-{{ id }}:hover svg {
          color: #fff;
        }
        #dots-{{ id }} .dot {
          width: 24px;
          height: 3px;
          border-radius: 9999px;
          background: var(--color-border);
          transition: all 400ms ease;
          cursor: pointer;
        }
        #dots-{{ id }} .dot.active {
          width: 40px;
          background: var(--color-accent);
        }
      </style>

      {# Swiper Init #}
      <script>
        (() => {
          var swiper = new Swiper('#swiper-{{ id }}', {
            slidesPerView: 1,
            spaceBetween: 24,
            grabCursor: true,
            loop: true,
            navigation: {
              prevEl: '#prev-{{ id }}',
              nextEl: '#next-{{ id }}'
            },
            breakpoints: {
              768: { slidesPerView: 2 },
              1024: { slidesPerView: 3 }
            }
          });

          /* Custom pagination dots */
          var dotsContainer = document.getElementById('dots-{{ id }}');
          var totalSlides = {{ reviews | length }};
          var perView = window.innerWidth >= 1024 ? 3 : window.innerWidth >= 768 ? 2 : 1;
          var dotCount = Math.max(totalSlides - perView + 1, 1);

          for (var i = 0; i < dotCount; i++) {
            var dot = document.createElement('span');
            dot.className = 'dot' + (i === 0 ? ' active' : '');
            dot.dataset.index = i;
            dot.addEventListener('click', function () {
              swiper.slideTo(parseInt(this.dataset.index));
            });
            dotsContainer.appendChild(dot);
          }

          swiper.on('slideChange', function () {
            var dots = dotsContainer.querySelectorAll('.dot');
            var idx = swiper.realIndex % dotCount;
            dots.forEach(function (d, j) {
              d.classList.toggle('active', j === idx);
            });
          });
        })();
      </script>

    {% else %}
      {# Empty State #}
      <div class="text-center py-16 flex items-center flex-col reveal">
        <svg class="w-12 h-12 mx-auto mb-4 text-tertiary" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24">
          <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <p class="text-secondary text-[15px]">
          {{ t('blocks.testimonials.no_reviews') | default('No reviews yet') }}
        </p>
      </div>
    {% endif %}

  </div>
</section>
